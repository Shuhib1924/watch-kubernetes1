<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport"
          content="width=device-width, initial-scale=1.0">
    <script src="https://unpkg.com/@tailwindcss/browser@4"></script>
    <script src="https://unpkg.com/alpinejs"
            defer></script>
    <title>Document</title>


</head>

<body x-data="autoReload()">
    <div class="container mx-auto p-8">
        <h1 class="text-4xl font-bold text-green-600 mb-4">🚀 FIXED AUTO-RELOAD - NO FALSE POSITIVES!</h1>
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded">
            ✅ This should sync immediately and port forwarding should reconnect automatically!
        </div>
        <div class="mt-4 text-gray-600">
            🔄 Pod restarts → Port forwarding reconnects → You see changes immediately!
        </div>
    </div>
    <div class="bg-emerald-100 border border-emerald-400 p-4 rounded mt-4">
        ✅ FIXED ISSUES: Better content detection + Proper Kubernetes sync timing!
    </div>
    <div class="bg-blue-100 p-3 rounded mt-2 text-sm">
        ⚡ How it works: Alpine.js checks for changes every 3 seconds → Auto-reloads when detected
    </div>

    <!-- Auto-reload control -->
    <div class="mt-4 p-4 bg-gray-50 rounded border">
        <h3 class="font-semibold mb-2">🔧 Auto-reload Controls</h3>
        <button @click="toggleAutoReload()"
                class="px-4 py-2 rounded text-white font-medium"
                :class="isActive ? 'bg-red-500 hover:bg-red-600' : 'bg-green-500 hover:bg-green-600'">
            <span x-text="isActive ? '⏹️ Stop Auto-reload' : '▶️ Start Auto-reload'"></span>
        </button>
        <p class="text-sm text-gray-600 mt-2">
            Status: <span :class="isActive ? 'text-green-600' : 'text-red-600'"
                  x-text="isActive ? 'Active' : 'Stopped'"></span>
        </p>
    </div>

    <!-- Auto-reload status indicators -->
    <div x-show="isReloading"
         x-transition
         class="fixed top-4 left-1/2 transform -translate-x-1/2 bg-green-500 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50">
        🔄 Reloading...
    </div>

    <div class="fixed bottom-4 right-4 bg-blue-500 text-white px-3 py-1 rounded-full text-sm shadow-lg z-40"
         :class="{ 'bg-green-500': isActive, 'bg-red-500': !isActive }">
        <span x-text="isActive ? '🔄 Auto-reload ON' : '❌ Auto-reload OFF'"></span>
    </div>

    <!-- Alpine.js Auto-reload Script -->
    <script>
        function autoReload() {
            return {
                isActive: true,
                isReloading: false,
                contentSignature: '',
                updateInterval: null,
                lastUpdateTime: 0,
                checkCount: 0,

                init() {
                    console.log('🚀 Alpine.js Auto-reload initialized');
                    // Wait longer for initial load to avoid false positives
                    setTimeout(() => {
                        this.setInitialSignature();
                        this.startWatching();
                    }, 3000);
                },

                setInitialSignature() {
                    // Create a stable content signature excluding dynamic elements
                    const bodyContent = document.body.innerHTML;
                    // Remove script tags and timestamp-dependent content
                    const cleanContent = bodyContent
                        .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                        .replace(/\s+/g, ' ')
                        .trim();

                    this.contentSignature = this.generateSignature(cleanContent);
                    sessionStorage.setItem('contentSignature', this.contentSignature);
                    this.lastUpdateTime = Date.now();

                    console.log('📝 Content signature set:', this.contentSignature.substring(0, 30) + '...');
                },

                generateSignature(content) {
                    // Create a more stable signature
                    let hash = content.length.toString();
                    for (let i = 0; i < content.length; i += Math.floor(content.length / 10)) {
                        hash += content.charCodeAt(i).toString();
                    }
                    return hash;
                },

                async checkForUpdates() {
                    if (!this.isActive) return;

                    this.checkCount++;

                    try {
                        // Use HEAD request first to check if server is responsive
                        const headResponse = await fetch('/', {
                            method: 'HEAD',
                            cache: 'no-cache'
                        });

                        if (!headResponse.ok) {
                            console.log('⚠️ Server not ready, skipping check');
                            return;
                        }

                        // Now get the full content
                        const response = await fetch('/?v=' + Date.now(), {
                            method: 'GET',
                            cache: 'no-cache',
                            headers: {
                                'Cache-Control': 'no-cache, no-store, must-revalidate',
                                'Pragma': 'no-cache'
                            }
                        });

                        const content = await response.text();

                        // Clean the content the same way
                        const cleanContent = content
                            .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                            .replace(/\s+/g, ' ')
                            .trim();

                        const currentSignature = this.generateSignature(cleanContent);
                        const storedSignature = sessionStorage.getItem('contentSignature');

                        // Only reload if content actually changed AND enough time has passed
                        const timeSinceLastUpdate = Date.now() - this.lastUpdateTime;

                        if (storedSignature &&
                            storedSignature !== currentSignature &&
                            timeSinceLastUpdate > 5000) { // At least 5 seconds since last update

                            console.log('🔄 Real content change detected! Reloading...');
                            console.log('Old signature:', storedSignature.substring(0, 30) + '...');
                            console.log('New signature:', currentSignature.substring(0, 30) + '...');

                            this.triggerReload();
                        } else if (this.checkCount % 10 === 0) {
                            // Debug log every 10 checks
                            console.log('👀 Check #' + this.checkCount + ' - No changes detected');
                        }

                    } catch (error) {
                        console.log('⚠️ Update check failed:', error.message);
                        // Server might be restarting, continue checking
                    }
                },

                triggerReload() {
                    this.isReloading = true;
                    // Clear the stored signature to avoid loops
                    sessionStorage.removeItem('contentSignature');

                    setTimeout(() => {
                        location.reload();
                    }, 1000);
                },

                startWatching() {
                    // Check every 4 seconds (slightly longer to reduce server load)
                    this.updateInterval = setInterval(() => {
                        this.checkForUpdates();
                    }, 4000);

                    console.log('👀 Started watching for changes every 4 seconds');
                },

                stopWatching() {
                    if (this.updateInterval) {
                        clearInterval(this.updateInterval);
                        this.updateInterval = null;
                        console.log('🛑 Stopped watching');
                    }
                },

                toggleAutoReload() {
                    this.isActive = !this.isActive;
                    if (this.isActive) {
                        this.setInitialSignature();
                        this.startWatching();
                    } else {
                        this.stopWatching();
                    }
                },

                destroy() {
                    this.stopWatching();
                    sessionStorage.removeItem('contentSignature');
                }
            }
        }

        // Cleanup on page unload
        window.addEventListener('beforeunload', () => {
            sessionStorage.removeItem('contentSignature');
        });
    </script>

</body>

</html>